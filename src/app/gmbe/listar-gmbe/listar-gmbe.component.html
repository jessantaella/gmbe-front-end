<app-notificaciones *ngIf="this.mostrarNotificaciones" ></app-notificaciones>
<div class="container-fluid">
  <div class="d-flex flex-row-reverse bd-highlight m-3">
    <div class="p-2 bd-highlight">
      <button [routerLink]="['/crear-gmbe']" class="btn-nuevo btn-sm"  *ngIf="this.idRol()===1 || idRol()===2 || this.idRol()===4 ">
        <em class='bi bi-plus'></em>
        Nuevo MBE
      </button>
    </div>
  </div>
  <div>
    <div class="table-responsive" >
      <table class="table table-striped table-bordered">
        <thead class="cabecera-tabla">
          <tr class="text-center ">
            <th scope="col">Ver</th>
            <th scope="col">Acciones</th>
            <th scope="col">MBE</th>
            <th scope="col">Quien lo creó</th>
            <th scope="col">Estatus</th>
            <th scope="col">Fecha de creación</th>
            <th scope="col">Fecha de publicación</th>
            <th scope="col">Gestión</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let mbe of listaMBE">
            <td class="text-center">
              <fa-icon [icon]="faEye" class="btn-acciones" [routerLink]="['/vista-previa',mbe.idMbe]"></fa-icon>
            </td>
            <td class="text-center">
              <div ngbDropdown class="d-inline-block" *ngIf="this.validarBotones(mbe.idEstatus.idCatalogo, mbe.maxRevision)">
                <button class="btn" id="dropdownBasic1" ngbDropdownToggle >
                  <fa-icon [icon]="faEllipsisVertical" class="btn-acciones"></fa-icon>
                </button>
                <div ngbDropdownMenu aria-labelledby="dropdownBasic1" >
                  <button *ngIf="this.validarAcciones(mbe.idEstatus.idCatalogo, 'aprobar')" ngbDropdownItem (click)="this.cambiarEstatusMBE(mbe.idMbe,200)" >Aprobar</button>
                  <button *ngIf="this.validarAcciones(mbe.idEstatus.idCatalogo, 'enviar')" ngbDropdownItem (click)="this.cambiarEstatusMBE(mbe.idMbe,175)" >Enviar a validar</button>
                  <button *ngIf="this.validarAcciones(mbe.idEstatus.idCatalogo, 'rechazar')" ngbDropdownItem (click)="this.cambiarEstatusMBE(mbe.idMbe,176)">Rechazar</button>
                  <button *ngIf="this.validarAcciones(mbe.idEstatus.idCatalogo, 'publicar')" ngbDropdownItem (click)="this.cambiarEstatusMBE(mbe.idMbe,174)">Publicar</button>
                </div>
              </div>
            </td>
            <td class="text-start">
              {{mbe?.nombre}}
            </td>
            <td class="text-center">{{mbe?.idUsuario?.nombre}}</td>
            <td class="text-center">
              {{mbe?.idEstatus.catalogo}}
            </td>
            <td class="text-center">{{ mbe?.created | date: 'dd-MM-yyyy' }}</td>
            <td class="text-center">{{mbe?.fechaPublicacion | date: 'dd-MM-yyyy'}}</td>
            <td class="text-center" >
                <fa-icon [icon]="faUpload" class="btn-acciones m-2" *ngIf="!mbe?.bloqueado && this.acciones(mbe,1) && (mbe.idEstatus.idCatalogo === this.creado || mbe.idEstatus.idCatalogo === this.rechazado) && this.idRol() !==3"
                  (click)="openCarga(cargaModal,mbe?.idMbe,mbe)"></fa-icon>
                <fa-icon [icon]="faUpload" class="btn-acciones-inabil m-2" *ngIf="mbe?.bloqueado || !this.acciones(mbe,1) || (mbe.idEstatus.idCatalogo !== this.creado && mbe.idEstatus.idCatalogo !== this.rechazado) || this.idRol() ===3"></fa-icon>
  
  
                <fa-icon [icon]="faPencil" class="btn-acciones m-2" [routerLink]="['/editar-gmbe',mbe?.idMbe]"
                  *ngIf="!mbe?.bloqueado && this.acciones(mbe,2 ) && (mbe.idEstatus.idCatalogo === this.creado || mbe.idEstatus.idCatalogo === this.rechazado) && this.idRol() !==3 "></fa-icon>
                <fa-icon [icon]="faPencil" class="btn-acciones-inabil m-2" *ngIf="mbe?.bloqueado || !this.acciones(mbe,2) || (mbe.idEstatus.idCatalogo !== this.creado && mbe.idEstatus.idCatalogo !== this.rechazado) || this.idRol() ===3"></fa-icon>
  
                <fa-icon [icon]="faXmarkCircle" *ngIf="(mbe?.bloqueado) && this.idRol() !==3 &&  this.idRol() !==2 &&  this.idRol() !==4" class="btn-acciones m-2 activo"
                  (click)="bloquearMbe(mbe?.idMbe,mbe?.bloqueado)"></fa-icon>
  
                <fa-icon [icon]="faCircleCheck" *ngIf="(!mbe?.bloqueado) && this.idRol() !==3 &&  this.idRol() !==2 &&  this.idRol() !==4" class="btn-acciones m-2 inactivo"
                  (click)="bloquearMbe(mbe?.idMbe,mbe?.bloqueado)"></fa-icon>
  
                <fa-icon [icon]="faCircleCheck" *ngIf="(!mbe?.bloqueado) && (this.idRol() === 3 || this.idRol() ===2 || this.idRol() ===4)" class="btn-acciones-inabil m-2"></fa-icon>
                <fa-icon [icon]="faXmarkCircle" *ngIf="(mbe?.bloqueado) && (this.idRol() === 3 || this.idRol() ===2 || this.idRol() ===4)" class="btn-acciones-inabil m-2"></fa-icon>
  
                <fa-icon [icon]="faTrashCan" class="btn-acciones m-2" *ngIf="((!mbe?.bloqueado) && this.idRol() !==3 &&  this.idRol() !==4 &&  this.idRol() !==2) && mbe.idEstatus.idCatalogo !== this.publicado"
                  (click)="eliminarGmbe(mbe?.idMbe)"></fa-icon>
                <fa-icon [icon]="faTrashCan" class="btn-acciones-inabil m-2" *ngIf="(mbe?.bloqueado)"></fa-icon>
  
                <fa-icon [icon]="faTrashCan" class="btn-acciones-inabil m-2" *ngIf="(!mbe?.bloqueado) && (this.idRol() ===3 || this.idRol() ===4 || this.idRol() ===2) || mbe.idEstatus.idCatalogo === this.publicado"></fa-icon>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="listaMBE.length<1">
          <tr >
            <td class="text-center align-middle" colspan="8">
              Sin resultados
            </td>
            
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <nav class="d-flex justify-content-center" *ngIf="totalPage>1">
    <ngb-pagination [(page)]="page" [collectionSize]="items" [maxSize]="10" [pageSize]="pageSize"
      (pageChange)="loadPage($event)" [rotate]="true" [directionLinks]="true" [boundaryLinks]="false">
    </ngb-pagination>
  </nav>
</div>


<ng-template #cargaModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title w-100 text-center titulo-modal">Cargar base de datos</h4>
  </div>
  <div class="modal-body texto">
    <form [formGroup]="cargaDatos">
      <div class="mb-3 row">

        <div class="col-xl-2 col-lg-2 text-center m-auto">
          <label for="usuario" class="col-sm-2 col-form-label">Archivo:</label>
        </div>
        
        <div class="col-xl-8 col-lg-8  m-auto">
          <input type="text" class="form-control" [ngClass]="{'input-movil':this.mostrarMensajeRevisiones}" id="usuario"  formControlName="nombre" readonly>
          <span class="text-danger my-1" *ngIf="this.mostrarMensajeRevisiones">Este MBE, ya tiene información cargada</span>
        </div>
    
        <div class="col-xl-2 col-lg-2" [ngClass]="{'margin-icon':this.mostrarMensajeRevisiones}">
          <div class="p-2 bd-highlight text-center">
            <div class="file-upload-wrapper">
              <input type="file" #fileInput class="file-upload-input" accept=".xlsx" (change)="onFileChange($event)">
              <i class="fas fa-upload upload-icon"></i>
            </div>
            <fa-icon [icon]="faX" class="btnOtrasAcciones m-2 eliminarImagen" (click)="clearImage(fileInput)"></fa-icon>
          </div>
        </div>

      </div>
    </form>
  </div>
  <div class="modal-footer justify-content-center botones-modal">
    <button type="button" class="btn btn-sm btn-cancelar color-btn-cancelar" (click)="modal.dismiss('Cancelar')">
      <fa-icon [icon]="faRotate"></fa-icon>
      Cancelar
    </button>
    <button type="button" class="btn btn-sm btn-guardar color-btn-guardar" (click)="cargardatos()" [disabled]="this.cargaDatos.valid" >
      <fa-icon [icon]="faFloppyDisk"></fa-icon>
      Guardar
    </button>
  </div>
</ng-template>

<ng-template #sinResultados>
  <div class="alert alert-info text-center m-3" role="alert">
    Sin resultados
  </div>
</ng-template>